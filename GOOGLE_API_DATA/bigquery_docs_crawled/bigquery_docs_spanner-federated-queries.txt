Source URL: https://cloud.google.com/bigquery/docs/spanner-federated-queries

BigQuery [https://cloud.google.com/bigquery?hl=ko]
Documentation [https://cloud.google.com/bigquery/docs?hl=ko]
가이드 [https://cloud.google.com/bigquery/docs/introduction?hl=ko]
도움이 되었나요?
의견 보내기
이 페이지의 내용
외부 데이터 세트 사용 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#use_external_datasets]
EXTERNAL_QUERY 함수 사용 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#use_external_query_function]
시작하기 전에 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#begin]
올바른 연결 선택 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#right-connection]
데이터 쿼리 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#query-data]
Spanner 통합 쿼리
bookmark_border
데이터 분석가는 통합 쿼리 [https://cloud.google.com/bigquery/docs/federated-queries-intro?hl=ko]를 사용하여 BigQuery에서 Spanner의 데이터를 쿼리할 수 있습니다.
BigQuery Spanner 통합을 사용하여 BigQuery는 데이터를 복사하거나 이동하지 않고도 Spanner에 있는 데이터를 실시간으로 쿼리할 수 있습니다.
다음 두 가지 방법으로 Spanner 데이터를 쿼리할 수 있습니다.
Spanner 외부 데이터 세트를 만듭니다.
EXTERNAL_QUERY [https://cloud.google.com/bigquery/docs/reference/standard-sql/federated_query_functions?hl=ko#external_query] 함수를 사용합니다.
외부 데이터 세트 사용
Spanner 테이블을 쿼리하는 가장 간단한 방법은 외부 데이터 세트를 만드는 것 [https://cloud.google.com/bigquery/docs/spanner-external-datasets?hl=ko]입니다. 외부 데이터 세트를 만들면 해당 Spanner 데이터베이스의 테이블이 BigQuery에 표시되며 쿼리(예: 조인, 합집합, 서브 쿼리)에서 이를 사용할 수 있습니다. 하지만 Spanner에서 BigQuery 스토리지로 데이터가 이동하지는 않습니다.
외부 데이터 세트를 만드는 경우 Spanner 데이터를 쿼리하기 위해 연결을 만들 필요가 없습니다.
EXTERNAL_QUERY 함수 사용
다른 제휴 데이터베이스와 마찬가지로 EXTERNAL_QUERY [https://cloud.google.com/bigquery/docs/reference/standard-sql/federated_query_functions?hl=ko#external_query] 함수를 사용하여 Spanner 데이터를 쿼리할 수도 있습니다. 이는 PostgreSQL 언어를 사용하는 Spanner 데이터베이스를 쿼리하거나 연결 매개변수를 더 세부적으로 제어하려는 경우에 유용할 수 있습니다.
시작하기 전에
BigQuery 관리자가 Spanner 연결 [https://cloud.google.com/bigquery/docs/connect-to-spanner?hl=ko#create-spanner-connection]을 만들어 사용자와 공유 [https://cloud.google.com/bigquery/docs/connect-to-spanner?hl=ko#share_connections]했는지 확인합니다. 올바른 연결 선택 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#right-connection]을 참조하세요.
Spanner 인스턴스를 쿼리하는 데 필요한 권한을 얻으려면 관리자에게 BigQuery 연결 사용자(roles/bigquery.connectionUser) Identity and Access Management(IAM) 역할을 부여해 달라고 요청하세요. 또한 다음 중 하나를 부여하도록 관리자에게 요청해야 합니다.
세분화된 액세스 제어 사용자는 쿼리의 모든 Spanner 스키마 객체에 대한 SELECT 권한이 있는 데이터베이스 역할에 액세스해야 합니다.
세분화된 액세스 제어 사용자가 아니면 Cloud Spanner 데이터베이스 리더(roles/spanner.databaseReader) IAM 역할이 필요합니다.
IAM 역할 부여에 대한 자세한 내은 프로젝트, 폴더, 조직에 대한 액세스 관리 [https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=ko]를 참조하세요. 세분화된 액세스 제어에 대한 자세한 내용은 세분화된 액세스 제어 정보 [https://cloud.google.com/spanner/docs/fgac-about?hl=ko]를 참조하세요.
올바른 연결 선택
Spanner 세분화된 액세스 제어 사용자인 경우 EXTERNAL_QUERY [https://cloud.google.com/bigquery/docs/reference/standard-sql/federated_query_functions?hl=ko#external_query] 함수를 사용하여 통합 쿼리를 실행할 때 데이터베이스 역할을 지정하는 Spanner 연결을 사용해야 합니다. 그러면 이 연결로 실행하는 모든 쿼리에 해당 데이터베이스 역할이 사용됩니다.
데이터베이스 역할을 지정하지 않는 연결을 사용하는 경우 시작하기 전에 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#begin]에 IAM 역할이 표시되어 있어야 합니다.
데이터 쿼리
GoogleSQL 쿼리에서 통합 쿼리를 Spanner로 보내려면 EXTERNAL_QUERY [https://cloud.google.com/bigquery/docs/reference/standard-sql/federated_query_functions?hl=ko#external_query] 함수를 사용합니다.
데이터베이스의 지정된 언어에 따라 GoogleSQL 또는 PostgreSQL로 Spanner 쿼리를 작성합니다.
다음 예시에서는 orders라는 Spanner 데이터베이스에 통합 쿼리를 수행하고 결과를 mydataset.customers라는 BigQuery 테이블과 조인합니다.
SELECT c.customer_id, c.name, rq.first_order_date
FROM mydataset.customers AS c
LEFT OUTER JOIN EXTERNAL_QUERY(
  'my-project.us.example-db',
  '''SELECT customer_id, MIN(order_date) AS first_order_date
  FROM orders
  GROUP BY customer_id''') AS rq
  ON rq.customer_id = c.customer_id
GROUP BY c.customer_id, c.name, rq.first_order_date;
Spanner Data Boost
Data Boost는 지원되는 Spanner 워크로드에 독립적인 컴퓨팅 리소스를 제공하는 완전 관리형 서버리스 기능입니다. Data Boost를 사용하면 프로비저닝된 Spanner 인스턴스의 기존 워크로드에 거의 영향을 주지 않고 분석 쿼리 및 데이터 내보내기를 실행할 수 있습니다. Data Boost를 사용하면 프로비저닝된 인스턴스와 별개로 독립적인 컴퓨팅 용량을 사용하여 통합 쿼리를 실행할 수 있으므로 Spanner의 기존 워크로드에 영향을 주지 않습니다. Data Boost는 복잡한 임시 쿼리를 실행하거나 기존 Spanner 워크로드에 영향을 주지 않고 대량의 데이터를 처리하려는 경우에 가장 효과적입니다. Data Boost로 통합 쿼리를 실행하면 CPU 소비를 크게 줄이고 경우에 따라 쿼리 지연 시간을 줄일 수 있습니다.
시작하기 전에
Data Boost에 대한 액세스를 사용 설정하는 데 필요한 권한을 얻으려면 관리자에게 Spanner 데이터베이스에 대한 Data Boost가 포함된 Cloud Spanner 데이터베이스 리더 [https://cloud.google.com/iam/docs/roles-permissions/spanner?hl=ko#spanner.databaseReaderWithDataBoost](roles/spanner.databaseReaderWithDataBoost) IAM 역할을 부여해 달라고 요청하세요. 역할 부여에 대한 자세한 내용은 프로젝트, 폴더, 조직에 대한 액세스 관리 [https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=ko]를 참조하세요.
이 사전 정의된 역할에는 Data Boost 액세스를 사용 설정하는 데 필요한 spanner.databases.useDataBoost 권한이 포함되어 있습니다.
커스텀 역할 [https://cloud.google.com/iam/docs/creating-custom-roles?hl=ko]이나 다른 사전 정의된 역할 [https://cloud.google.com/iam/docs/roles-overview?hl=ko#predefined]을 사용하여 이 권한을 부여받을 수도 있습니다.
Data Boost 사용 설정
외부 데이터 세트를 사용하는 경우 항상 Data Boost가 사용되므로 수동으로 사용 설정할 필요가 없습니다.
EXTERNAL_QUERY 쿼리에 Data Boost를 사용하려면 쿼리에서 사용하는 연결을 만들 때 [https://cloud.google.com/bigquery/docs/connect-to-spanner?hl=ko] Data Boost를 사용 설정해야 합니다.
동시에 데이터 읽기
Spanner에서는 특정 쿼리를 더 작은 부분이나 파티션 여러 개로 나누고 파티션을 동시에 가져올 수 있습니다. 제한사항 목록을 비롯한 자세한 내용은 Spanner 문서의 동시에 데이터 읽기 [https://cloud.google.com/spanner/docs/reads?hl=ko#read_data_in_parallel]를 참조하세요.
Spanner 쿼리의 쿼리 실행 계획을 보려면 Spanner의 쿼리 실행 방법 이해 [https://cloud.google.com/spanner/docs/sql-best-practices?hl=ko#how-execute-queries]를 참조하세요.
외부 데이터 세트로 제휴 쿼리를 실행할 때는 '데이터를 동시에 읽기' 옵션이 항상 사용됩니다.
EXTERNAL_QUERY [https://cloud.google.com/bigquery/docs/reference/standard-sql/federated_query_functions?hl=ko#external_query]를 사용할 때 동시 읽기를 사용 설정하려면 연결을 만들 때 [https://cloud.google.com/bigquery/docs/connect-to-spanner?hl=ko] 사용 설정하세요.
쿼리 실행 우선순위 관리
EXTERNAL_QUERY 함수로 제휴 쿼리를 실행할 때 query_execution_priority 옵션을 지정하여 개별 쿼리에 우선순위(high, medium 또는 low)를 할당할 수 있습니다.
SELECT *
FROM EXTERNAL_QUERY(
  'my-project.us.example-db',
  '''SELECT customer_id, MIN(order_date) AS first_order_date
  FROM orders
  GROUP BY customer_id''',
  '{"query_execution_priority":"high"}');
기본 우선순위는 medium입니다.
우선순위가 high인 쿼리는 트랜잭션 트래픽과 경합합니다. 우선순위가 low인 쿼리는 최대한 노력이 지원되며 예약된 백업과 같은 백그라운드 로드에 의해 선점될 수 있습니다.
주의: 우선순위가 low인 쿼리는 BigQuery의 제한 시간 내에 완료되지 않을 수 있는 백업 작업과 같은 쿼리 아래로 내려갈 수 있습니다.
외부 데이터 세트로 통합 쿼리를 실행할 때 모든 쿼리는 항상 medium 우선순위를 갖습니다.
Spanner 테이블 스키마 보기
외부 데이터 세트를 사용하는 경우 Spanner 테이블이 BigQuery Studio에 직접 표시되며 스키마를 볼 수 있습니다.
하지만 외부 데이터 세트를 정의하지 않고도 스키마를 볼 수 있습니다. EXTERNAL_QUERY 함수를 사용하여 information_schema 뷰를 쿼리하여 데이터베이스 메타데이터에 액세스할 수도 있습니다. 다음 예시에서는 MyTable 테이블의 열에 대한 정보를 반환합니다.
--- 탭: Google SQL 데이터베이스 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#google-sql-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4] ---
SELECT *
FROM EXTERNAL_QUERY(
  'my-project.us.example-db',
  '''SELECT t.column_name, t.spanner_type, t.is_nullable
    FROM information_schema.columns AS t
    WHERE
      t.table_catalog = ''
      AND t.table_schema = ''
     AND t.table_name = 'MyTable'
    ORDER BY t.ordinal_position
  ''');

--- 탭: PostgreSQL 데이터베이스 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#postgresql-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4] ---
SELECT * from EXTERNAL_QUERY(
 'my-project.us.postgresql.example-db',
  '''SELECT t.column_name, t.data_type, t.is_nullable
    FROM information_schema.columns AS t
    WHERE
      t.table_schema = 'public' and t.table_name='MyTable'
    ORDER BY t.ordinal_position
  ''');
자세한 내용은 Spanner 문서의 다음 정보 스키마 참조 문서를 확인하세요.
GoogleSQL 정보 스키마 [https://cloud.google.com/spanner/docs/information-schema?hl=ko]
PostgreSQL 정보 스키마 [https://cloud.google.com/spanner/docs/information-schema-pg?hl=ko]
가격 책정
BigQuery 측에서는 표준 통합 쿼리 가격 책정 [https://cloud.google.com/bigquery/docs/federated-queries-intro?hl=ko#pricing]이 적용됩니다.
Spanner 측에서는 쿼리에 Spanner 가격 책정 [https://cloud.google.com/spanner/pricing?hl=ko]이 적용됩니다.
리전 간 쿼리
프리뷰
이 제품 또는 기능에는 서비스별 약관 [https://cloud.google.com/terms/service-terms?hl=ko#1]의 일반 서비스 약관 섹션에 있는 'GA 이전 제공 서비스 약관'이 적용됩니다. GA 이전 제품 및 기능은 '있는 그대로' 제공되며 지원이 제한될 수 있습니다. 자세한 내용은 출시 단계 설명 [https://cloud.google.com/products?hl=ko#product-launch-stages]을 참조하세요.
참고: 프리뷰 중에 지원을 받으려면 spanner-analytics-federation-customer-champions@google.com [mailto:spanner-analytics-federation-customer-champions@google.com]으로 이메일을 보내세요.
BigQuery는 Spanner 인스턴스와 BigQuery 데이터 세트가 서로 다른 리전에 있는 통합 쿼리를 지원합니다. 이러한 쿼리에는 추가 Spanner 데이터 전송 요금이 부과됩니다. 자세한 내용은 Spanner 가격 책정 [https://cloud.google.com/spanner/pricing?hl=ko#network]을 참조하세요.
프리뷰 기간에는 데이터 전송에 대한 요금이 청구되지 않지만 다음 SKU [https://cloud.google.com/skus/sku-groups/cloud-spanner?hl=ko]로 사용량을 확인할 수 있습니다.
네트워크 리전 내 교차 영역 데이터 아웃바운드 전송
동일한 대륙으로의 무료 인스턴스 네트워크 리전 간 데이터 아웃바운드 전송
다른 대륙으로의 무료 인스턴스 네트워크 리전 간 데이터 아웃바운드 전송
데이터 전송 요금은 쿼리를 실행하는 BigQuery 리전과 읽기-쓰기 또는 읽기 전용 복제본이 있는 가장 가까운 Spanner 리전을 기준으로 청구됩니다.
BigQuery 멀티 리전 구성(US 또는 EU)의 경우 Spanner의 데이터 전송 비용은 다음과 같이 결정됩니다.
BigQuery US 멀티 리전: Spanner 리전 us-central1
BigQuery EU 멀티 리전: Spanner 리전 europe-west1
예를 들면 다음과 같습니다.
BigQuery(US 멀티 리전) 및 Spanner(us-central1): 동일한 리전 내의 데이터 전송에 비용이 부과됩니다.
BigQuery(US 멀티 리전) 및 Spanner(us-west4): 동일한 대륙 내 리전 간 데이터 전송에 비용이 부과됩니다.
문제 해결
이 섹션은 통합 쿼리를 Spanner에 전송할 때 발생할 수 있는 문제를 해결하는 데 도움이 됩니다.
문제: 쿼리를 루트로 분할할 수 없습니다.
해결 방법: 데이터를 병렬로 읽도록 연결을 구성하는 경우 쿼리 실행 계획의 첫 번째 연산자가 분산 통합이거나 실행 계획에 분산 통합이 없어야 합니다. 이 오류를 해결하려면 쿼리 실행 계획을 보고 쿼리를 다시 작성합니다. 자세한 내용은 Spanner의 쿼리 실행 방법 이해 [https://cloud.google.com/spanner/docs/sql-best-practices?hl=ko#how-execute-queries]를 참조하세요.
문제: 기한이 지났습니다.
해결 방법: 데이터 병렬로 읽기 [https://cloud.google.com/bigquery/docs/spanner-federated-queries?hl=ko#read_data_in_parallel] 옵션을 선택하여 루트 분할이 가능한 쿼리를 다시 작성합니다. 자세한 내용은 Spanner의 쿼리 실행 방법 이해 [https://cloud.google.com/spanner/docs/sql-best-practices?hl=ko#how-execute-queries]를 참조하세요.
다음 단계
Spanner 외부 데이터 세트 만들기 [https://cloud.google.com/bigquery/docs/spanner-external-datasets?hl=ko] 알아보기
통합 쿼리 [https://cloud.google.com/bigquery/docs/federated-queries-intro?hl=ko] 알아보기
Spanner에서 BigQuery로의 데이터 유형 매핑 [https://cloud.google.com/bigquery/docs/reference/standard-sql/federated_query_functions?hl=ko#spanner-mapping] 알아보기
도움이 되었나요?
의견 보내기