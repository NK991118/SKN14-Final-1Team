Source URL: https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore

BigQuery [https://cloud.google.com/bigquery?hl=ko]
Documentation [https://cloud.google.com/bigquery/docs?hl=ko]
가이드 [https://cloud.google.com/bigquery/docs/introduction?hl=ko]
도움이 되었나요?
의견 보내기
이 페이지의 내용
제한사항 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#limitations]
시작하기 전에 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#before_you_begin]
필수 권한 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#required_permissions]
Cloud Storage에서 데이터를 로드할 수 있는 권한 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#permissions-load-data-from-cloud-storage]
Firestore 내보내기 서비스 데이터 로드 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#loading_cloud_firestore_export_service_data]
Firestore 옵션 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#cloud_firestore_options]
데이터 유형 변환 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#data_type_conversion]
Firestore 키 속성 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#firestore_key_properties]
Firestore 내보내기에서 데이터 로드
bookmark_border
BigQuery에서는 Firestore 관리형 가져오기 및 내보내기 서비스 [https://cloud.google.com/firestore/docs/manage-data/export-import?hl=ko]로 만든 Firestore [https://cloud.google.com/firestore?hl=ko] 내보내기에서 데이터를 로드할 수 있습니다. 관리형 가져오기 및 내보내기 서비스는 Firestore 문서를 Cloud Storage 버킷으로 내보냅니다. 그런 다음 내보낸 데이터를 BigQuery 테이블로 로드할 수 있습니다.
참고: 모든 Firestore 내보내기를 로드할 수 있지는 않습니다. BigQuery 테이블에 로드할 수 있는 Firesotre 내보내기를 만들려면 BigQuery 제한사항 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#limitations]을 참조하세요.
제한사항
Firestore 내보내기에서 BigQuery로 데이터를 로드할 때는 다음 제한사항에 유의하세요.
데이터 세트는 내보내기 파일이 포함된 Cloud Storage 버킷과 같은 위치에 있어야 합니다.
Cloud Storage URI를 하나만 지정할 수 있으며 URI 와일드 카드를 사용할 수 없습니다.
Firestore 내보내기를 올바르게 로드하려면 내보내기 데이터의 문서가 고유한 필드 이름이 10,000개 미만인 일관된 스키마를 공유해야 합니다.
데이터를 저장할 새 테이블을 만들거나 기존 테이블을 덮어쓸 수 있습니다. 하지만 Firestore 내보내기 데이터를 기존 테이블에 추가할 수 없습니다.
내보내기 명령어 [https://cloud.google.com/firestore/docs/manage-data/export-import?hl=ko#export_data]에는 collection-ids 필터를 지정해야 합니다. 컬렉션 ID 필터를 지정하지 않고 내보낸 데이터는 BigQuery에 로드할 수 없습니다.
시작하기 전에
사용자에게 이 문서의 각 작업을 수행하는 데 필요한 권한을 부여하는 Identity and Access Management(IAM) 역할을 부여합니다.
필수 권한
데이터를 BigQuery로 로드하려면 로드 작업을 실행하고 데이터를 BigQuery 테이블과 파티션으로 로드할 수 있는 IAM 권한이 필요합니다. Cloud Storage에서 데이터를 로드할 경우 데이터가 포함된 버킷에 액세스할 수 있는 IAM 권한도 필요합니다.
데이터를 BigQuery로 로드할 수 있는 권한
데이터를 새 BigQuery 테이블이나 파티션으로 로드하거나 기존 테이블 또는 파티션을 추가하거나 덮어쓰려면 다음 IAM 권한이 필요합니다.
bigquery.tables.create
bigquery.tables.updateData
bigquery.tables.update
bigquery.jobs.create
다음과 같이 사전 정의된 각 IAM 역할에는 데이터를 BigQuery 테이블이나 파티션에 로드하기 위해 필요한 권한이 포함되어 있습니다.
roles/bigquery.dataEditor
roles/bigquery.dataOwner
roles/bigquery.admin(bigquery.jobs.create 권한 포함)
bigquery.user(bigquery.jobs.create 권한 포함)
bigquery.jobUser(bigquery.jobs.create 권한 포함)
또한 bigquery.datasets.create 권한이 있으면 만들 데이터 세트에서 로드 작업을 사용하여 테이블을 만들고 업데이트할 수 있습니다.
BigQuery의 IAM 역할과 권한에 대한 자세한 내용은 사전 정의된 역할 및 권한 [https://cloud.google.com/bigquery/access-control?hl=ko]을 참조하세요.
Cloud Storage에서 데이터를 로드할 수 있는 권한
Cloud Storage 버킷에서 데이터를 로드하는 데 필요한 권한을 얻으려면 관리자에게 버킷에 대한 스토리지 관리자 [https://cloud.google.com/iam/docs/roles-permissions/storage?hl=ko#storage.admin](roles/storage.admin) IAM 역할을 부여해 달라고 요청하세요. 역할 부여에 대한 자세한 내용은 프로젝트, 폴더, 조직에 대한 액세스 관리 [https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=ko]를 참조하세요.
이 사전 정의된 역할에는 Cloud Storage 버킷에서 데이터를 로드하는 데 필요한 권한이 포함되어 있습니다. 필요한 정확한 권한을 보려면 필수 권한 섹션을 펼치세요.
필수 권한
커스텀 역할 [https://cloud.google.com/iam/docs/creating-custom-roles?hl=ko]이나 다른 사전 정의된 역할 [https://cloud.google.com/iam/docs/roles-overview?hl=ko#predefined]을 사용하여 이 권한을 부여받을 수도 있습니다.
Firestore 내보내기 서비스 데이터 로드
Google Cloud 콘솔, bq 명령줄 도구 [https://cloud.google.com/bigquery/docs/bq-command-line-tool?hl=ko] 또는 API [https://cloud.google.com/bigquery/docs/reference/rest/v2?hl=ko]를 사용하여 Firestore 내보내기 메타데이터 파일에서 데이터를 로드할 수 있습니다.
경우에 따라 Datastore 용어가 Google Cloud 콘솔과 bq 명령줄 도구에 사용되지만 다음 절차는 Firestore 내보내기 파일과 호환됩니다. Firestore와 Datastore는 내보내기 형식을 공유합니다.
참고: bq 명령줄 도구에서--projection_fields 플래그 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#cloud_firestore_options]를 사용하거나 load 작업 구성에서 projectionFields 속성을 설정하여 특정 필드를 로드할 수 있습니다.
--- 탭: 콘솔 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#%EC%BD%98%EC%86%94] ---
Google Cloud 콘솔에서 BigQuery 페이지로 이동합니다.
    BigQuery로 이동 [https://console.cloud.google.com/bigquery?hl=ko]

탐색기 창에서 프로젝트를 펼친 후 데이터 세트를 선택합니다.
데이터 세트 정보 섹션에서 add_box 테이블 만들기를 클릭합니다.
 테이블 만들기 패널에서 다음 세부정보를 지정합니다. 


  



소스 섹션의 다음 항목으로 테이블 만들기 목록에서 Google Cloud Storage를 선택합니다.
  그런 후 다음 작업을 수행합니다.
  
    Cloud Storage 버킷에서 파일을 선택하거나 Cloud Storage URI [https://cloud.google.com/bigquery/docs/batch-loading-data?hl=ko#gcs-uri]를 입력합니다.
              Google Cloud 콘솔에는 URI 여러 개가 포함될 수 없지만 와일드 카드 [https://cloud.google.com/bigquery/docs/batch-loading-data?hl=ko#load-wildcards]는 지원됩니다. Cloud Storage 버킷은 생성, 추가 또는 덮어쓰려는 테이블이 포함된 데이터 세트와 동일한 위치에 있어야 합니다.
      

       Firestore 내보내기 파일의 URI는 KIND_COLLECTION_ID.export_metadata로 끝나야 합니다. 예를 들어 default_namespace_kind_Book.export_metadata에서 Book은 컬렉션 ID이고 default_namespace_kind_Book은 Firestore에서 생성된 파일 이름입니다. URI가 KIND_COLLECTION_ID.export_metadata로 끝나지 않으면 다음과 같은 오류 메시지가 표시됩니다.
유효한 백업 메타데이터를 포함하지 않습니다 (error code: invalid).

      
참고: overall_export_metadata로 끝나는 파일을 사용하지 마세요. BigQuery에서는 이러한 파일을 사용할 수 없습니다.
      
      





    파일 형식으로 Cloud Datastore 백업을 선택합니다. Firestore와 Datastore는 내보내기 형식을 공유합니다.
      
  

    





대상 섹션에서 다음 세부정보를 지정합니다.데이터 세트에서 테이블을 만들 데이터 세트를 선택합니다.
  테이블 필드에 만들려는 테이블의 이름을 입력합니다.
  테이블 유형 필드가 기본 테이블로 설정되어 있는지 확인합니다.
  




    스키마 섹션은 그대로 놔둡니다. 스키마는 Firestore 내보내기에 대해 유추됩니다.
  



  
  



  
  선택사항: 파티션 및 클러스터 설정을 지정합니다. 자세한 내용은 파티션을 나눈 테이블 만들기 [https://cloud.google.com/bigquery/docs/creating-partitioned-tables?hl=ko] 및 클러스터링된 테이블 만들기 및 사용 [https://cloud.google.com/bigquery/docs/creating-clustered-tables?hl=ko]을 참조하세요.
    
  



   




고급 옵션을 클릭하고 다음을 수행합니다.





  
  쓰기 환경설정에서 비어 있으면 쓰기를 선택한 상태로 둡니다. 이 옵션은 새 테이블을 만들어 데이터를 로드합니다.
  

  

  테이블 스키마에 없는 행의 값을 무시하려면 알 수 없는 값을 선택합니다.

  
  Cloud Key Management Service 키 [https://cloud.google.com/bigquery/docs/customer-managed-encryption?hl=ko]를 사용하려면 암호화에서 고객 관리 키를 클릭합니다.
        Google-managed key 설정을 그대로 두면 BigQuery에서 저장 데이터를 암호화 [https://cloud.google.com/security/encryption/default-encryption?hl=ko]합니다.

  
  



테이블 만들기를 클릭합니다.

--- 탭: bq [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#bq] ---
source_format이 DATASTORE_BACKUP으로 설정된 bq load [https://cloud.google.com/bigquery/docs/reference/bq-cli-reference?hl=ko#bq_load] 명령어를 사용합니다.
--location 플래그를 지정하고 값을 사용자 위치 [https://cloud.google.com/bigquery/docs/locations?hl=ko]로 설정합니다. 기존 테이블을 덮어쓰는 경우 --replace 플래그를 추가합니다.

특정 필드만 로드하려면 --projection_fields 플래그 [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#cloud_firestore_options]를 사용합니다.
bq --location=LOCATION load \
--source_format=FORMAT \
DATASET.TABLE \
PATH_TO_SOURCE

다음을 바꿉니다.


LOCATION: 사용자 위치입니다. --location 플래그는 선택사항입니다.
FORMAT: DATASTORE_BACKUP.
Datastore 백업은 Firestore에 올바른 옵션입니다.
Firestore와 Datastore는 내보내기 형식을 공유합니다.
DATASET: 데이터를 로드할 테이블이 포함된 데이터 세트입니다.
TABLE: 데이터를 로드할 대상 테이블입니다.
테이블이 없으면 생성됩니다.
PATH_TO_SOURCE: Cloud Storage URI [https://cloud.google.com/bigquery/docs/batch-loading-data?hl=ko#gcs-uri]입니다.


예를 들어 다음 명령어는 Firestore 내보내기 파일 gs://mybucket/20180228T1256/default_namespace/kind_Book/default_namespace_kind_Book.export_metadata를 book_data라는 테이블로 로드합니다.
mybucket과 mydataset는 US 멀티 리전 위치에서 생성되었습니다.
bq --location=US load \
--source_format=DATASTORE_BACKUP \
mydataset.book_data \
gs://mybucket/20180228T1256/default_namespace/kind_Book/default_namespace_kind_Book.export_metadata

--- 탭: API [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#api] ---
API [https://cloud.google.com/bigquery/docs/reference/v2?hl=ko]를 사용하여 Firestore 내보내기 데이터를 로드하려면 다음 속성을 설정합니다.


Cloud Storage의 소스 데이터를 가리키는 load 작업 구성을 만듭니다.
작업 리소스 [https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs?hl=ko]의 jobReference 섹션에 있는 location 속성에 사용자 위치 [https://cloud.google.com/bigquery/docs/locations?hl=ko]를 지정합니다.
sourceUris는 로드 작업 구성에서 gs://BUCKET/OBJECT 형식으로 정규화되어야 합니다. 파일(객체) 이름은 KIND_NAME.export_metadata로 끝나야 합니다. Firestore 내보내기에는 URI가 하나만 허용되며 와일드 카드를 사용할 수 없습니다.
로드 작업 구성에서 sourceFormat 속성을 DATASTORE_BACKUP으로 설정하여 데이터 형식을 지정합니다. Datastore 백업은 Firestore에 올바른 옵션입니다. Firestore와 Datastore는 내보내기 형식을 공유합니다.
특정 필드만 로드하려면 projectionFields 속성을 설정합니다.
기존 테이블을 덮어쓰려면 writeDisposition 속성을 WRITE_TRUNCATE로 설정하여 쓰기 처리를 지정합니다.

--- 탭: Python [https://cloud.google.com/bigquery/docs/loading-data-cloud-firestore?hl=ko#python] ---
이 샘플을 사용해 보기 전에 BigQuery 빠른 시작: 클라이언트 라이브러리 사용 [https://cloud.google.com/bigquery/docs/quickstarts/quickstart-client-libraries?hl=ko]의 Python 설정 안내를 따르세요.
        
      
      
  자세한 내용은 BigQuery Python API 참고 문서 [https://cloud.google.com/python/docs/reference/bigquery/latest?hl=ko]를 확인하세요.
  
    
    
      BigQuery에 인증하려면 애플리케이션 기본 사용자 인증 정보를 설정합니다.
      자세한 내용은 클라이언트 라이브러리의 인증 설정 [https://cloud.google.com/bigquery/docs/authentication?hl=ko#client-libs]을 참조하세요.
      
    
      






    
  
  
  
  




















  





  
    
  
  











  









  




  



  


  # TODO(developer): Set table_id to the ID of the table to create.
table_id = "your-project.your_dataset.your_table_name"

# TODO(developer): Set uri to the path of the kind export metadata
uri = (
    "gs://cloud-samples-data/bigquery/us-states"
    "/2021-07-02T16:04:48_70344/all_namespaces/kind_us-states"
    "/all_namespaces_kind_us-states.export_metadata"
)

# TODO(developer): Set projection_fields to a list of document properties
#                  to import. Leave unset or set to `None` for all fields.
projection_fields = ["name", "post_abbr"]

from google.cloud import bigquery [https://cloud.google.com/python/docs/reference/bigquery/latest/?hl=ko]

# Construct a BigQuery client object.
client = bigquery [https://cloud.google.com/python/docs/reference/bigquery/latest/?hl=ko].Client [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.client.Client.html?hl=ko]()

job_config = bigquery [https://cloud.google.com/python/docs/reference/bigquery/latest/?hl=ko].LoadJobConfig [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.job.LoadJobConfig.html?hl=ko](
    source_format=bigquery [https://cloud.google.com/python/docs/reference/bigquery/latest/?hl=ko].SourceFormat [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.enums.SourceFormat.html?hl=ko].DATASTORE_BACKUP,
    projection_fields=projection_fields,
)

load_job = client.load_table_from_uri [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.client.Client.html?hl=ko#google_cloud_bigquery_client_Client_load_table_from_uri](
    uri, table_id, job_config=job_config
)  # Make an API request.

load_job.result()  # Waits for the job to complete.

destination_table = client.get_table [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.client.Client.html?hl=ko#google_cloud_bigquery_client_Client_get_table](table_id)
print("Loaded {} rows.".format(destination_table.num_rows [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.table.Table.html?hl=ko#google_cloud_bigquery_table_Table_num_rows]))
참고: 로드 프로세스를 건너뛰려면 내보내기를 외부 데이터 소스로 설정하여 직접 쿼리할 수 있습니다. 자세한 내용은 외부 데이터 소스 [https://cloud.google.com/bigquery/external-data-sources?hl=ko]를 참조하세요.
Firestore 옵션
BigQuery가 Firestore 내보내기 데이터를 파싱하는 방법을 변경하려면 다음 옵션을 지정합니다.
Google Cloud 콘솔 옵션 `bq` 플래그 BigQuery API 속성 설명
사용 불가능 --projection_fields projectionFields (자바 [https://cloud.google.com/java/docs/reference/google-cloud-bigquery/latest/com.google.cloud.bigquery.DatastoreBackupOptions.Builder?hl=ko#com_google_cloud_bigquery_DatastoreBackupOptions_Builder_setProjectionFields_java_util_List_java_lang_String__], Python [https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.job.LoadJobConfig?hl=ko#google_cloud_bigquery_job_LoadJobConfig_projection_fields]) (선택사항) Firestore 내보내기에서 로드할 문서 필드를 나타내는 쉼표로 구분된 목록입니다. BigQuery는 기본적으로 모든 필드를 로드합니다. 필드 이름은 대소문자를 구분하며 내보내기에 있어야 합니다. map.foo와 같은 맵 필드 내에 필드 경로를 지정할 수 없습니다.
데이터 유형 변환
BigQuery는 Firestore 내보내기 파일에 있는 각 문서의 데이터를 BigQuery 데이터 유형 [https://cloud.google.com/bigquery/docs/schemas?hl=ko#standard_sql_data_types]으로 변환합니다. 다음 표에서는 지원되는 데이터 유형 간의 변환을 설명합니다.
Firestore 데이터 유형 BigQuery 데이터 유형
배열 RECORD
Boolean 부울
참조 RECORD
날짜 및 시간 TIMESTAMP
지도 RECORD
부동 소수점 수 FLOAT
지리적 지점
RECORD
[{"lat","FLOAT"},
 {"long","FLOAT"}]
        
정수 정수
문자열 STRING(64KB로 잘림)
Firestore 키 속성
Firestore의 각 문서에는 문서 ID, 문서 경로와 같은 정보가 포함된 고유 키가 있습니다. BigQuery는 다음 표의 설명대로 각 정보의 중첩 필드를 사용하여 키의 RECORD 데이터 유형(STRUCT [https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types?hl=ko#struct_type]라고도 함)을 만듭니다.
키 속성 설명 BigQuery 데이터 유형
__key__.app Firestore 앱 이름입니다. STRING
__key__.id 문서의 ID이거나 __key__.name가 설정된 경우에는 null입니다. 정수
__key__.kind 문서의 컬렉션 ID입니다. STRING
__key__.name 문서의 이름이거나 __key__.id가 설정된 경우에는 null입니다. STRING
__key__.namespace Firestore는 커스텀 네임스페이스를 지원하지 않습니다. 기본 네임스페이스는 빈 문자열로 표시됩니다. STRING
__key__.path 문서의 경로이며, 루트 컬렉션의 일련의 문서와 컬렉션 쌍입니다. 예를 들면 "Country", "USA", "PostalCode", 10011, "Route", 1234입니다. STRING
도움이 되었나요?
의견 보내기